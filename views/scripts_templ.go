// Code generated by templ - DO NOT EDIT.

// templ: version: v0.3.960
package views

//lint:file-ignore SA4006 This context is only used if a nested component is present.

import "github.com/a-h/templ"
import templruntime "github.com/a-h/templ/runtime"

// sharedAnsiUtilities contains common ANSI processing functions used across pages
func sharedAnsiUtilities() templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var1 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var1 == nil {
			templ_7745c5c3_Var1 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 1, "<script type=\"module\">\n\t\t// Shared ANSI color mapping for brightening dark colors\n\t\t// Makes dark 8-bit ANSI colors more visible on dark backgrounds\n\t\tconst ANSI_COLOR_BRIGHTENING_MAP = {\n\t\t\t// Standard ANSI colors (0-7) - brighten significantly\n\t\t\t'rgb(0,0,187)': 'rgb(137,180,250)',      // Dark blue ‚Üí light blue\n\t\t\t'rgb(0,187,0)': 'rgb(166,227,161)',      // Dark green ‚Üí light green\n\t\t\t'rgb(187,0,187)': 'rgb(243,139,168)',    // Dark magenta ‚Üí light magenta\n\t\t\t'rgb(187,0,0)': 'rgb(252,165,165)',      // Dark red ‚Üí light red\n\t\t\t'rgb(187,187,0)': 'rgb(253,224,71)',     // Dark yellow ‚Üí bright yellow\n\t\t\t'rgb(0,187,187)': 'rgb(137,220,235)',    // Dark cyan ‚Üí light cyan\n\t\t\t// Bright ANSI colors (8-15) - improve contrast\n\t\t\t'rgb(85,85,85)': 'rgb(163,163,163)',     // Bright black (gray) ‚Üí lighter gray\n\t\t\t'rgb(255,85,85)': 'rgb(252,165,165)',    // Bright red ‚Üí softer red\n\t\t\t'rgb(85,255,85)': 'rgb(134,239,172)',    // Bright green ‚Üí softer green\n\t\t\t'rgb(255,255,85)': 'rgb(253,224,71)',    // Bright yellow ‚Üí softer yellow\n\t\t\t'rgb(85,85,255)': 'rgb(147,197,253)',    // Bright blue ‚Üí softer blue\n\t\t\t'rgb(255,85,255)': 'rgb(244,114,182)',   // Bright magenta ‚Üí softer magenta\n\t\t\t'rgb(85,255,255)': 'rgb(165,243,252)'    // Bright cyan ‚Üí softer cyan\n\t\t};\n\n\t\t// Shared function to brighten ANSI colors\n\t\twindow.brightenAnsiColors = function(html) {\n\t\t\tlet result = html;\n\t\t\tfor (const [dark, light] of Object.entries(ANSI_COLOR_BRIGHTENING_MAP)) {\n\t\t\t\t// Escape special regex characters in color values\n\t\t\t\tconst escaped = dark.replace(/[()]/g, '\\\\$&');\n\t\t\t\tresult = result.replace(new RegExp(escaped, 'g'), light);\n\t\t\t}\n\t\t\treturn result;\n\t\t};\n\t</script>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

// indexPageInlineScript contains the inline JavaScript for IndexPage (AnsiUp setup)
func indexPageInlineScript() templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var2 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var2 == nil {
			templ_7745c5c3_Var2 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = sharedAnsiUtilities().Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 2, "<script type=\"module\">\n\t\t\timport { AnsiUp } from 'https://cdn.jsdelivr.net/npm/ansi_up@6/ansi_up.js';\n\t\t\tconst ansiUp = new AnsiUp();\n\t\t\tansiUp.escapeHtml = true;\n\n\t\t\t// Convert ANSI to HTML with brightening (uses shared brightenAnsiColors)\n\t\t\twindow.ansiToHtml = function(text) {\n\t\t\t\t// Convert tmux's visible ESC symbol (‚êõ, U+241B) to real ESC byte\n\t\t\t\ttext = text.replace(/\\u241b/g, '\\x1b');\n\t\t\t\tlet html = ansiUp.ansi_to_html(text);\n\t\t\t\t// Strip any orphaned ANSI codes that survived (ESC lost in transmission)\n\t\t\t\thtml = html.replace(/\\[[0-9;]*m/g, '');\n\t\t\t\treturn window.brightenAnsiColors(html);\n\t\t\t};\n\t</script>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

func paneScripts() templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var3 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var3 == nil {
			templ_7745c5c3_Var3 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 3, "<script>\n\t\t// Theme support - must run synchronously before render\n\t\t(function() {\n\t\t\tconst saved = localStorage.getItem('houston-theme');\n\t\t\tif (saved === 'light') {\n\t\t\t\tdocument.documentElement.setAttribute('data-theme', 'light');\n\t\t\t} else if (!saved && window.matchMedia('(prefers-color-scheme: light)').matches) {\n\t\t\t\tdocument.documentElement.setAttribute('data-theme', 'light');\n\t\t\t}\n\t\t})();\n\t</script>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = sharedAnsiUtilities().Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 4, "<script type=\"module\">\n\t\timport { AnsiUp } from 'https://cdn.jsdelivr.net/npm/ansi_up@6/ansi_up.js';\n\n\t\tconst ansiUp = new AnsiUp();\n\t\tansiUp.escapeHtml = true;  // Ensure HTML is escaped (v6 uses camelCase)\n\n\t\t// Strip ANSI background colors from ansi_up output\n\t\t// Only target rgb() values (ansi_up uses rgb, not rgba) to avoid stripping CSS code in terminal content\n\t\tfunction fixBackgrounds(html) {\n\t\t\thtml = html.replace(/background-color:\\s*rgb\\([^)]+\\);?/gi, '');\n\t\t\treturn html;\n\t\t}\n\n\t\t// Add subtle backgrounds for diff lines\n\t\t// Claude Code format: \"703 +  code\" or \"703 -  code\" (line number, space, +/-, space, code)\n\t\tfunction enhanceDiffs(html) {\n\t\t\tconst lines = html.split('\\n');\n\t\t\treturn lines.map(line => {\n\t\t\t\tconst stripped = line.replace(/<[^>]*>/g, ''); // Strip HTML tags to check content\n\t\t\t\t// Match Claude Code diff format: line_number +/- code\n\t\t\t\tconst match = stripped.match(/^\\s*\\d+\\s+([-+])\\s/);\n\t\t\t\tif (match) {\n\t\t\t\t\tif (match[1] === '+') {\n\t\t\t\t\t\treturn '<span class=\"diff-add\">' + line + '</span>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn '<span class=\"diff-del\">' + line + '</span>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// Also match standard diff format (starts with +/- directly)\n\t\t\t\tif (stripped.startsWith('+') && !stripped.startsWith('+++')) {\n\t\t\t\t\treturn '<span class=\"diff-add\">' + line + '</span>';\n\t\t\t\t} else if (stripped.startsWith('-') && !stripped.startsWith('---')) {\n\t\t\t\t\treturn '<span class=\"diff-del\">' + line + '</span>';\n\t\t\t\t} else if (stripped.startsWith('@@')) {\n\t\t\t\t\treturn '<span class=\"diff-hunk\">' + line + '</span>';\n\t\t\t\t}\n\t\t\t\treturn line;\n\t\t\t}).join('\\n');\n\t\t}\n\n\t\t// Highlight user input lines with subtle background\n\t\tfunction highlightUserInput(html) {\n\t\t\tconst lines = html.split('\\n');\n\t\t\tlet inUserInput = false;\n\t\t\treturn lines.map(line => {\n\t\t\t\tconst stripped = line.replace(/<[^>]*>/g, ''); // Strip HTML tags to check content\n\t\t\t\tconst trimmed = stripped.trim();\n\n\t\t\t\t// Check if this is a prompt line (starts with >)\n\t\t\t\tif (/^\\s*>/.test(stripped)) {\n\t\t\t\t\tinUserInput = true;\n\t\t\t\t\treturn '<span class=\"user-input\">' + line + '</span>';\n\t\t\t\t}\n\n\t\t\t\t// Check if this is a horizontal separator (ends user input block)\n\t\t\t\tif (/^[\\s‚îÄ]{20,}$/.test(stripped)) {\n\t\t\t\t\tinUserInput = false;\n\t\t\t\t\treturn line;\n\t\t\t\t}\n\n\t\t\t\t// Check if this is an indented continuation of user input\n\t\t\t\t// (starts with spaces and we're in user input mode)\n\t\t\t\tif (inUserInput && /^\\s{2,}/.test(stripped) && trimmed.length > 0) {\n\t\t\t\t\treturn '<span class=\"user-input\">' + line + '</span>';\n\t\t\t\t}\n\n\t\t\t\t// Empty line might continue user input block\n\t\t\t\tif (inUserInput && trimmed.length === 0) {\n\t\t\t\t\treturn line;\n\t\t\t\t}\n\n\t\t\t\t// Any non-indented content ends user input block\n\t\t\t\tif (trimmed.length > 0 && !/^\\s{2,}/.test(stripped)) {\n\t\t\t\t\tinUserInput = false;\n\t\t\t\t}\n\n\t\t\t\treturn line;\n\t\t\t}).join('\\n');\n\t\t}\n\n\t\tfunction processOutput(text) {\n\t\t\ttry {\n\t\t\t\t// Normalize line endings and remove carriage returns\n\t\t\t\ttext = text.replace(/\\r\\n/g, '\\n').replace(/\\r/g, '');\n\t\t\t\t\n\t\t\t\t// Extract OSC 8 hyperlinks BEFORE ansi_up (which escapes HTML)\n\t\t\t\t// Store them with placeholders, restore after\n\t\t\t\tconst links = [];\n\t\t\t\ttext = extractOSC8Links(text, links);\n\t\t\t\t\n\t\t\t\tlet html = ansiUp.ansi_to_html(text);\n\t\t\t\t// Brighten dark ANSI colors for better visibility (uses shared function)\n\t\t\t\thtml = window.brightenAnsiColors(html);\n\t\t\t\thtml = highlightUserInput(html);\n\t\t\t\t\n\t\t\t\t// Restore OSC 8 links as HTML\n\t\t\t\thtml = restoreOSC8Links(html, links);\n\t\t\t\t\n\t\t\t\treturn html;\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error('ansi_up error:', err);\n\t\t\t\t// Fallback: escape HTML and preserve newlines\n\t\t\t\treturn text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n\t\t\t}\n\t\t}\n\t\t\n\t\t// Extract OSC 8 links and replace with placeholders\n\t\tfunction extractOSC8Links(text, links) {\n\t\t\t// OSC 8 format: \\x1b]8;id=xxx;url\\x1b\\\\visible_text\\x1b]8;;\\x1b\\\\\n\t\t\t// Or with \\x07 (BEL) as terminator\n\t\t\tconst osc8Pattern = /\\x1b\\]8;([^;]*);([^\\x1b\\x07]*?)(?:\\x1b\\\\|\\x07)(.*?)\\x1b\\]8;;(?:\\x1b\\\\|\\x07)/g;\n\t\t\t\n\t\t\treturn text.replace(osc8Pattern, (match, params, url, linkText) => {\n\t\t\t\tconst placeholder = `__OSC8LINK_${links.length}__`;\n\t\t\t\tlinks.push({ url, text: linkText });\n\t\t\t\treturn placeholder;\n\t\t\t});\n\t\t}\n\t\t\n\t\t// Restore OSC 8 links from placeholders to HTML\n\t\tfunction restoreOSC8Links(html, links) {\n\t\t\t// Pattern for visible ANSI escape symbols (tmux sometimes uses ‚êõ instead of \\x1b)\n\t\t\tconst visibleAnsiPattern = /‚êõ\\[[0-9;]*[a-zA-Z]/g;\n\t\t\t\n\t\t\tfor (let i = 0; i < links.length; i++) {\n\t\t\t\tlet { url, text } = links[i];\n\t\t\t\t// Strip any visible ANSI sequences from link text\n\t\t\t\ttext = text.replace(visibleAnsiPattern, '');\n\t\t\t\tconst placeholder = `__OSC8LINK_${i}__`;\n\t\t\t\t// Only allow http/https URLs to prevent javascript: XSS\n\t\t\t\tconst safeUrl = url.startsWith('http://') || url.startsWith('https://') ? url : '#';\n\t\t\t\tconst link = `<a href=\"${safeUrl}\" class=\"terminal-link\" target=\"_blank\">${text}</a>`;\n\t\t\t\thtml = html.replace(placeholder, link);\n\t\t\t}\n\t\t\treturn html;\n\t\t}\n\n\t\tdocument.addEventListener('DOMContentLoaded', function() {\n\t\t\tconst container = document.getElementById('output-container');\n\t\t\tif (container) {\n\t\t\t\tcontainer.scrollTop = container.scrollHeight;\n\t\t\t}\n\t\t\tconst output = document.getElementById('output');\n\t\t\tif (output) {\n\t\t\t\tconst text = output.textContent;\n\t\t\t\toutput.innerHTML = processOutput(text);\n\t\t\t\t// Check for pending input on initial load\n\t\t\t\tupdatePendingInput(text);\n\t\t\t}\n\t\t});\n\n\t\t// Track current vim mode (persists across SSE messages)\n\t\tlet currentVimMode = '';\n\t\t\n\t\t// Track current agent type for scroll behavior\n\t\tlet currentAgentType = 'generic';\n\t\t\n\t\t// Send scroll keys to Amp (called from scroll buttons)\n\t\twindow.ampScroll = function(direction) {\n\t\t\tconst container = document.getElementById('output-container');\n\t\t\tconst paneTarget = container?.getAttribute('data-pane-target');\n\t\t\tif (!paneTarget) return;\n\t\t\t\n\t\t\t// Dim container until SSE refreshes (with fallback timeout)\n\t\t\tcontainer.classList.add('scrolling');\n\t\t\tsetTimeout(() => container.classList.remove('scrolling'), 2000);\n\t\t\t\n\t\t\tconst key = direction === 'up' ? 'PPage' : 'NPage';\n\t\t\tfetch(`/pane/${paneTarget}/send`, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\tbody: `input=${key}&special=true`\n\t\t\t}).catch(err => console.error('Scroll send failed:', err));\n\t\t};\n\n\t\t// Handle SSE messages manually to prevent htmx from setting innerHTML directly\n\t\t// This prevents terminal content with HTML-like text from being rendered as actual HTML\n\t\tdocument.body.addEventListener('htmx:sseMessage', function(e) {\n\t\t\tconsole.debug('SSE message received', e.detail.data?.length || 0, 'bytes');\n\t\t\tconst output = document.getElementById('output');\n\t\t\tif (!output) return;\n\n\t\t\tconst container = document.getElementById('output-container');\n\t\t\t// Check if user is at the bottom before updating (with 50px threshold)\n\t\t\tconst wasAtBottom = container &&\n\t\t\t\t(container.scrollTop + container.clientHeight >= container.scrollHeight - 50);\n\n\t\t\t// Get the raw text from SSE (already safe as plain text)\n\t\t\tlet text = e.detail.data;\n\n\t\t\t// Track current mode, agent type, and Claude mode for status indicators\n\t\t\tlet currentMode = '';\n\t\t\tlet currentAgent = 'generic';\n\t\t\tlet claudeModeData = {};\n\n\t\t\t// Extract mode from special first line if present\n\t\t\tconst modeMatch = text.match(/^__MODE__:(\\w*)\\n/);\n\t\t\tif (modeMatch) {\n\t\t\t\tcurrentMode = modeMatch[1];\n\t\t\t\tcurrentVimMode = currentMode; // Persist for form submission\n\t\t\t\ttext = text.substring(modeMatch[0].length);\n\t\t\t\tupdateModeIndicatorDirect(currentMode);\n\t\t\t}\n\n\t\t\t// Extract agent type if present\n\t\t\tconst agentMatch = text.match(/^__AGENT__:([^\\n]*)\\n/);\n\t\t\tif (agentMatch) {\n\t\t\t\tcurrentAgent = agentMatch[1] || 'generic';\n\t\t\t\tcurrentAgentType = currentAgent; // Update global for scroll handling\n\t\t\t\ttext = text.substring(agentMatch[0].length);\n\t\t\t\t// Store agent type for choice handling\n\t\t\t\tconst bar = document.getElementById('choices-bar');\n\t\t\t\tif (bar) bar.dataset.agentType = currentAgent;\n\t\t\t}\n\n\t\t\t// Extract choices from special line if present\n\t\t\tconst choicesMatch = text.match(/^__CHOICES__:([^\\n]*)\\n/);\n\t\t\tif (choicesMatch) {\n\t\t\t\tconst choicesStr = choicesMatch[1];\n\t\t\t\ttext = text.substring(choicesMatch[0].length);\n\t\t\t\tupdateChoices(choicesStr ? choicesStr.split('|') : [], currentAgent);\n\t\t\t}\n\n\t\t\t// Extract Claude mode state if present (JSON)\n\t\t\tconst claudeModeMatch = text.match(/^__CLAUDEMODE__:([^\\n]*)\\n/);\n\t\t\tif (claudeModeMatch) {\n\t\t\t\ttext = text.substring(claudeModeMatch[0].length);\n\t\t\t\ttry {\n\t\t\t\t\tclaudeModeData = JSON.parse(claudeModeMatch[1] || '{}');\n\t\t\t\t\tupdateClaudeMode(claudeModeData);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.warn('Failed to parse Claude mode:', e);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Extract status line with ANSI colors (newlines encoded as ‚êä)\n\t\t\tconst statusLineMatch = text.match(/^__STATUSLINE__:([^\\n]*)\\n/);\n\t\t\tlet rawStatusLine = '';\n\t\t\tif (statusLineMatch) {\n\t\t\t\t// Restore newlines from placeholder\n\t\t\t\trawStatusLine = statusLineMatch[1].replace(/‚êä/g, '\\n');\n\t\t\t\ttext = text.substring(statusLineMatch[0].length);\n\t\t\t}\n\n\t\t\t// Extract structured Amp status\n\t\t\tconst ampStatusMatch = text.match(/^__AMPSTATUS__:(\\{[^\\n]*\\})\\n/);\n\t\t\tif (ampStatusMatch) {\n\t\t\t\ttext = text.substring(ampStatusMatch[0].length);\n\t\t\t\ttry {\n\t\t\t\t\tconst ampStatus = JSON.parse(ampStatusMatch[1]);\n\t\t\t\t\tupdateAmpStatus(ampStatus);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.warn('Failed to parse Amp status:', e, ampStatusMatch[1]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Extract prompt suggestion (try anchored first, fallback to search anywhere)\n\t\t\tlet suggestionMatch = text.match(/^__SUGGESTION__:([^\\n]*)\\n/);\n\t\t\tif (suggestionMatch) {\n\t\t\t\ttext = text.substring(suggestionMatch[0].length);\n\t\t\t} else {\n\t\t\t\t// Fallback: find __SUGGESTION__ anywhere in text (in case previous extractions shifted position)\n\t\t\t\tconst idx = text.indexOf('__SUGGESTION__:');\n\t\t\t\tif (idx !== -1) {\n\t\t\t\t\tconst end = text.indexOf('\\n', idx);\n\t\t\t\t\tif (end !== -1) {\n\t\t\t\t\t\tsuggestionMatch = [text.substring(idx, end + 1), text.substring(idx + '__SUGGESTION__:'.length, end)];\n\t\t\t\t\t\ttext = text.substring(0, idx) + text.substring(end + 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (suggestionMatch) {\n\t\t\t\tupdateSuggestion(suggestionMatch[1] || '');\n\t\t\t}\n\n\t\t\tif (currentAgent === 'claude-code' && rawStatusLine) {\n\t\t\t\t// For Claude Code, show raw status line\n\t\t\t\tupdateClaudeStatusLine(rawStatusLine);\n\t\t\t}\n\n\t\t\t// Update mode indicators (combines mode + claudeMode state)\n\t\t\tupdateModeIndicators(currentMode, claudeModeData);\n\n\t\t\t// Process with ansi_up (which has escapeHtml enabled)\n\t\t\toutput.innerHTML = processOutput(text);\n\n\t\t\t// Update pending input bar\n\t\t\tupdatePendingInput(text);\n\n\t\t\t// Only auto-scroll if user was already at the bottom\n\t\t\tif (wasAtBottom && container) {\n\t\t\t\tcontainer.scrollTop = container.scrollHeight;\n\t\t\t}\n\t\t\t\n\t\t\t// Clear scroll dimming (from Amp scroll buttons)\n\t\t\tif (container) {\n\t\t\t\tcontainer.classList.remove('scrolling');\n\t\t\t}\n\t\t});\n\n\t\t// Update choices bar dynamically\n\t\tfunction updateChoices(choices, agentType) {\n\t\t\tconst bar = document.getElementById('choices-bar');\n\t\t\tif (!bar) return;\n\n\t\t\tif (!choices || choices.length === 0 || (choices.length === 1 && choices[0] === '')) {\n\t\t\t\tbar.classList.add('hidden');\n\t\t\t\tbar.innerHTML = '';\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst isAmp = agentType === 'amp';\n\t\t\tbar.classList.remove('hidden');\n\t\t\tlet html = '';\n\t\t\tchoices.forEach((choice, i) => {\n\t\t\t\tconst num = i + 1;\n\t\t\t\tconst shortChoice = choice.length > 20 ? choice.substring(0, 17) + '...' : choice;\n\t\t\t\t// For Amp, store index for arrow navigation; for Claude, use number\n\t\t\t\thtml += `<button class=\"choice-btn\" data-choice=\"${num}\" data-choice-index=\"${i}\" data-choice-text=\"${escapeHtml(choice)}\">\n\t\t\t\t\t<span class=\"choice-num\">${isAmp ? '‚Üì' + i : num}</span>\n\t\t\t\t\t<span class=\"choice-text\">${escapeHtml(shortChoice)}</span>\n\t\t\t\t</button>`;\n\t\t\t});\n\t\t\tbar.innerHTML = html;\n\t\t}\n\n\t\tfunction escapeHtml(text) {\n\t\t\tconst div = document.createElement('div');\n\t\t\tdiv.textContent = text;\n\t\t\treturn div.innerHTML;\n\t\t}\n\n\t\t// Send choice to pane\n\t\twindow.sendChoice = async function(num, choiceText, choiceIndex) {\n\t\t\tconst bar = document.getElementById('choices-bar');\n\t\t\tif (!bar) return;\n\t\t\tconst target = bar.dataset.paneTarget;\n\t\t\tconst agentType = bar.dataset.agentType || 'generic';\n\t\t\tif (!target) return;\n\n\t\t\t// Visual feedback - disable all choice buttons during send\n\t\t\tconst buttons = bar.querySelectorAll('.choice-btn');\n\t\t\tconst clickedBtn = bar.querySelector(`[data-choice=\"${num}\"]`);\n\t\t\tbuttons.forEach(btn => btn.disabled = true);\n\t\t\tif (clickedBtn) {\n\t\t\t\tclickedBtn.classList.add('sending');\n\t\t\t\tclickedBtn.querySelector('.choice-num').textContent = '...';\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tif (agentType === 'amp') {\n\t\t\t\t\t// Amp uses cursor navigation: send Down arrows then Enter\n\t\t\t\t\t// First choice (index 0) is already selected, just send Enter\n\t\t\t\t\tawait sendAmpChoice(target, choiceIndex);\n\t\t\t\t} else {\n\t\t\t\t\t// Claude uses numbers\n\t\t\t\t\tconst response = await fetch(`/pane/${target}/send`, {\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\t\t\tbody: `input=${num}&noenter=true`\n\t\t\t\t\t});\n\t\t\t\t\tif (!response.ok) {\n\t\t\t\t\t\tthrow new Error(`Send failed: ${response.status}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// If choice says \"Type here\" or similar, focus input for custom response\n\t\t\t\tif (choiceText && choiceText.toLowerCase().includes('type')) {\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tconst inputField = document.getElementById('input-field');\n\t\t\t\t\t\tif (inputField) {\n\t\t\t\t\t\t\tinputField.focus();\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 100);\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error('Failed to send choice:', err);\n\t\t\t\t// Re-enable buttons on error\n\t\t\t\tbuttons.forEach(btn => btn.disabled = false);\n\t\t\t\tif (clickedBtn) {\n\t\t\t\t\tclickedBtn.classList.remove('sending');\n\t\t\t\t\tclickedBtn.querySelector('.choice-num').textContent = num;\n\t\t\t\t}\n\t\t\t\talert('Failed to send choice. Please try again.');\n\t\t\t}\n\t\t}\n\n\t\t// Send Amp choice using arrow navigation\n\t\tasync function sendAmpChoice(target, index) {\n\t\t\t// Send Down arrow 'index' times, then Enter\n\t\t\tfor (let i = 0; i < index; i++) {\n\t\t\t\tconst response = await fetch(`/pane/${target}/send`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\t\tbody: 'input=Down&special=true'\n\t\t\t\t});\n\t\t\t\tif (!response.ok) {\n\t\t\t\t\tthrow new Error(`Failed to send Down key: ${response.status}`);\n\t\t\t\t}\n\t\t\t\t// Small delay between key presses for terminal to process\n\t\t\t\tawait new Promise(r => setTimeout(r, 50));\n\t\t\t}\n\t\t\t// Send Enter to confirm\n\t\t\tconst response = await fetch(`/pane/${target}/send`, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\tbody: 'input=Enter&special=true'\n\t\t\t});\n\t\t\tif (!response.ok) {\n\t\t\t\tthrow new Error(`Failed to send Enter key: ${response.status}`);\n\t\t\t}\n\t\t}\n\n\t\t// Event delegation for choice buttons (avoids HTML entity escaping issues in onclick)\n\t\tdocument.addEventListener('click', function(e) {\n\t\t\tconst choiceBtn = e.target.closest('.choice-btn');\n\t\t\tif (choiceBtn) {\n\t\t\t\te.stopPropagation();\n\t\t\t\tconst num = choiceBtn.dataset.choice;\n\t\t\t\tconst text = choiceBtn.dataset.choiceText;\n\t\t\t\tconst index = parseInt(choiceBtn.dataset.choiceIndex || '0', 10);\n\t\t\t\tif (num) {\n\t\t\t\t\tsendChoice(num, text, index);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// Log SSE connection events\n\t\tdocument.body.addEventListener('htmx:sseOpen', function(e) {\n\t\t\tconsole.log('SSE connected');\n\t\t});\n\n\t\tdocument.body.addEventListener('htmx:sseError', function(e) {\n\t\t\tconsole.warn('SSE error', e.detail);\n\t\t});\n\n\t\t// Update mode indicator based on mode string from server\n\t\tfunction updateModeIndicatorDirect(mode) {\n\t\t\tconst modeEl = document.getElementById('mode-indicator');\n\t\t\tif (!modeEl) return;\n\n\t\t\tif (mode === 'insert') {\n\t\t\t\tmodeEl.textContent = 'INS';\n\t\t\t\tmodeEl.className = 'text-xs px-2 py-1 bg-green-600 text-white rounded font-medium shadow-sm';\n\t\t\t} else {\n\t\t\t\tmodeEl.textContent = 'NOR';\n\t\t\t\tmodeEl.className = 'text-xs px-2 py-1 bg-blue-600 text-white rounded font-medium shadow-sm';\n\t\t\t}\n\t\t}\n\n\t\t// Fallback: Update mode indicator by parsing text (for initial page load)\n\t\tfunction updateModeIndicator(text) {\n\t\t\tconst modeEl = document.getElementById('mode-indicator');\n\t\t\tif (!modeEl) return;\n\n\t\t\t// Check last few lines for INSERT mode\n\t\t\tconst lines = text.split('\\n').slice(-10).join('\\n');\n\t\t\tconst isInsert = lines.includes('-- INSERT --');\n\n\t\t\tif (isInsert) {\n\t\t\t\tmodeEl.textContent = 'INS';\n\t\t\t\tmodeEl.className = 'text-xs px-2 py-1 bg-green-600 text-white rounded font-medium shadow-sm';\n\t\t\t} else {\n\t\t\t\tmodeEl.textContent = 'NOR';\n\t\t\t\tmodeEl.className = 'text-xs px-2 py-1 bg-blue-600 text-white rounded font-medium shadow-sm';\n\t\t\t}\n\t\t}\n\n\t\twindow.toggleMenu = function() {\n\t\t\tdocument.getElementById('menu').classList.toggle('hidden');\n\t\t}\n\n\t\twindow.scrollToTop = function() {\n\t\t\tdocument.getElementById('output-container').scrollTop = 0;\n\t\t\tdocument.getElementById('menu').classList.add('hidden');\n\t\t}\n\n\t\t// Click on prompt pattern to focus input field\n\t\t// Detects: ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ separator lines and > prompt lines\n\t\twindow.handleOutputClick = function(e) {\n\t\t\t// Don't interfere with text selection\n\t\t\tif (window.getSelection().toString()) return;\n\n\t\t\t// Get the text at click position\n\t\t\tlet clickedLine = '';\n\n\t\t\t// Try to get the line that was clicked\n\t\t\tif (document.caretRangeFromPoint) {\n\t\t\t\tconst range = document.caretRangeFromPoint(e.clientX, e.clientY);\n\t\t\t\tif (range && range.startContainer) {\n\t\t\t\t\tconst text = range.startContainer.textContent || '';\n\t\t\t\t\t// Get the line containing the click position\n\t\t\t\t\tconst lines = text.split('\\n');\n\t\t\t\t\tlet pos = 0;\n\t\t\t\t\tfor (const line of lines) {\n\t\t\t\t\t\tif (pos + line.length >= range.startOffset) {\n\t\t\t\t\t\t\tclickedLine = line;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpos += line.length + 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Check if clicked line is a prompt pattern\n\t\t\tconst isPromptLine = (\n\t\t\t\tclickedLine.match(/^\\s*>{1,3}\\s*/) ||            // > or >>> (with optional text)\n\t\t\t\tclickedLine.match(/^[‚îÄ‚îÅ\\-]{5,}/)                 // Separator line (‚îÄ‚îÄ‚îÄ‚îÄ)\n\t\t\t);\n\n\t\t\tif (isPromptLine) {\n\t\t\t\tdocument.getElementById('input-field').focus();\n\t\t\t}\n\t\t}\n\n\t\t// Strip ANSI escape codes from text\n\t\tfunction stripAnsi(text) {\n\t\t\treturn text.replace(/\\x1b\\[[0-9;]*m/g, '');\n\t\t}\n\n\t\t// Extract pending input from Claude's prompt line(s)\n\t\t// Claude Code shows: \">\" or \">>>\" followed by user's typed text\n\t\t// Multi-line input shows continuation lines after the first prompt\n\t\tfunction extractPendingInput(text) {\n\t\t\tconst lines = text.split('\\n');\n\t\t\tconst pendingLines = [];\n\t\t\tlet foundPrompt = false;\n\n\t\t\t// Scan from bottom up to find prompt area\n\t\t\tfor (let i = lines.length - 1; i >= Math.max(0, lines.length - 20); i--) {\n\t\t\t\tconst line = lines[i];\n\n\t\t\t\t// Match prompt line: > or >>> with optional text\n\t\t\t\t// Allow ANSI escape codes before the prompt (e.g., \\u001b[0m>)\n\t\t\t\tconst promptMatch = line.match(/^(?:\\x1b\\[[0-9;]*m)*\\s*(>{1,3})\\s*(.*)$/);\n\n\t\t\t\tif (promptMatch) {\n\t\t\t\t\tfoundPrompt = true;\n\t\t\t\t\tlet content = stripAnsi(promptMatch[2]); // Strip ANSI codes from content\n\t\t\t\t\t// Remove pasted text indicators like \"[Pasted text #1 +10 lines]\"\n\t\t\t\t\tcontent = content.replace(/\\[Pasted text #\\d+ \\+\\d+.*?\\]/g, '').trim();\n\t\t\t\t\tif (content) {\n\t\t\t\t\t\tpendingLines.unshift(content); // Add to front (we're going backwards)\n\t\t\t\t\t}\n\t\t\t\t} else if (foundPrompt) {\n\t\t\t\t\t// We found prompts but this line doesn't have one\n\t\t\t\t\tlet trimmed = stripAnsi(line.trim());\n\t\t\t\t\t// Stop if we hit a separator, empty line, or status bar content\n\t\t\t\t\tif (!trimmed || trimmed.match(/^[‚îÄ‚îÅ\\-]{5,}/) ||\n\t\t\t\t\t\ttrimmed.includes('-- INSERT --') || trimmed.includes('-- NORMAL --')) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\t// Skip pasted text indicator lines\n\t\t\t\t\tif (trimmed.match(/^\\[Pasted text #\\d+/)) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\t// Check if this might be a continuation line (no prompt, just content)\n\t\t\t\t\t// Claude wraps long input, so continuation lines are possible\n\t\t\t\t\t// But stop if we hit obvious non-prompt content\n\t\t\t\t\tif (trimmed.startsWith('‚îÇ') || trimmed.startsWith('‚éø') ||\n\t\t\t\t\t\ttrimmed.startsWith('‚óè') || trimmed.startsWith('‚úª')) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\t// This could be wrapped input text, add it\n\t\t\t\t\tpendingLines.unshift(trimmed);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (pendingLines.length === 0) {\n\t\t\t\treturn foundPrompt ? '' : null; // Empty prompt vs no prompt\n\t\t\t}\n\n\t\t\treturn pendingLines.join('\\n');\n\t\t}\n\n\t\t// Update pending input bar based on output\n\t\tfunction updatePendingInput(text) {\n\t\t\tconst pendingBar = document.getElementById('pending-input-bar');\n\t\t\tconst pendingText = document.getElementById('pending-input-text');\n\t\t\tif (!pendingBar || !pendingText) return;\n\n\t\t\tconst pending = extractPendingInput(text);\n\t\t\tif (pending && pending.length > 0) {\n\t\t\t\t// Show first line + indicator if multi-line\n\t\t\t\tconst lines = pending.split('\\n');\n\t\t\t\tlet display = lines[0];\n\t\t\t\tif (lines.length > 1) {\n\t\t\t\t\tdisplay += ` (+${lines.length - 1} more)`;\n\t\t\t\t}\n\t\t\t\tpendingText.textContent = display;\n\t\t\t\tpendingText.title = pending; // Full text on hover\n\t\t\t\tpendingBar.classList.remove('hidden');\n\t\t\t} else {\n\t\t\t\tpendingBar.classList.add('hidden');\n\t\t\t}\n\t\t}\n\n\t\t// Track whether user dismissed the current suggestion\n\t\tlet suggestionDismissed = false;\n\t\t// Initialize from server-rendered suggestion (if any)\n\t\tlet currentSuggestion = document.getElementById('suggestion-text')?.textContent || '';\n\n\t\t// Update suggestion bar from SSE data\n\t\tfunction updateSuggestion(text) {\n\t\t\tconst bar = document.getElementById('suggestion-bar');\n\t\t\tconst textEl = document.getElementById('suggestion-text');\n\t\t\tif (!bar || !textEl) {\n\t\t\t\tconsole.warn('Suggestion bar elements not found');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!text) {\n\t\t\t\t// Empty suggestion from SSE (CC working or no suggestion)\n\t\t\t\t// Don't hide - keep showing the last suggestion until user acts\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// New suggestion text arrived\n\t\t\tif (text !== currentSuggestion) {\n\t\t\t\t// Different suggestion - reset dismissal, show it\n\t\t\t\tcurrentSuggestion = text;\n\t\t\t\tsuggestionDismissed = false;\n\t\t\t}\n\n\t\t\tif (suggestionDismissed) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttextEl.textContent = text;\n\t\t\ttextEl.title = text;\n\t\t\tbar.classList.remove('hidden');\n\t\t}\n\n\t\t// Pre-fill input with suggestion text\n\t\twindow.useSuggestion = function() {\n\t\t\tconst textEl = document.getElementById('suggestion-text');\n\t\t\tconst inputField = document.getElementById('input-field');\n\t\t\tif (!textEl || !inputField) return;\n\n\t\t\tinputField.value = textEl.title || textEl.textContent;\n\t\t\tautoResize(inputField);\n\t\t\tinputField.focus();\n\t\t\tdocument.getElementById('suggestion-bar')?.classList.add('hidden');\n\t\t}\n\n\t\t// Send suggestion directly\n\t\twindow.sendSuggestion = function() {\n\t\t\tconst textEl = document.getElementById('suggestion-text');\n\t\t\tconst paneTarget = document.getElementById('output-container')?.getAttribute('data-pane-target');\n\t\t\tif (!textEl || !paneTarget) return;\n\n\t\t\tconst text = textEl.title || textEl.textContent;\n\t\t\tif (!text) return;\n\n\t\t\tdocument.getElementById('suggestion-bar')?.classList.add('hidden');\n\t\t\tsuggestionDismissed = true;\n\t\t\tcurrentSuggestion = '';\n\n\t\t\t// Switch to INSERT mode if needed\n\t\t\tconst modeSwitch = currentVimMode === 'normal'\n\t\t\t\t? fetch(`/pane/${paneTarget}/send`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\t\tbody: 'input=i&noenter=true'\n\t\t\t\t}).then(() => new Promise(r => setTimeout(r, 50)))\n\t\t\t\t: Promise.resolve();\n\n\t\t\tmodeSwitch.then(() => {\n\t\t\t\tfetch(`/pane/${paneTarget}/send`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\t\tbody: `input=${encodeURIComponent(text)}`\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\t// Dismiss suggestion\n\t\twindow.dismissSuggestion = function() {\n\t\t\tdocument.getElementById('suggestion-bar')?.classList.add('hidden');\n\t\t\tsuggestionDismissed = true;\n\t\t\tcurrentSuggestion = '';\n\t\t}\n\n\t\t// Edit pending input - copy to input field for editing\n\t\twindow.editPendingInput = function() {\n\t\t\tconst pendingText = document.getElementById('pending-input-text');\n\t\t\tconst inputField = document.getElementById('input-field');\n\t\t\tif (!pendingText || !inputField) return;\n\n\t\t\t// Get full text from title attribute (textContent may be truncated)\n\t\t\tconst fullText = pendingText.title || pendingText.textContent;\n\t\t\tif (fullText) {\n\t\t\t\t// Only fill input field if it's empty (don't overwrite user input)\n\t\t\t\tif (inputField.value.trim() === '') {\n\t\t\t\t\tinputField.value = fullText;\n\t\t\t\t\tautoResize(inputField);\n\t\t\t\t}\n\t\t\t\tinputField.focus();\n\n\t\t\t\t// Clear the existing input in Claude (send Ctrl+U to clear line)\n\t\t\t\tconst bar = document.getElementById('choices-bar');\n\t\t\t\tconst target = bar?.dataset.paneTarget;\n\t\t\t\tif (target) {\n\t\t\t\t\tfetch(`/pane/${target}/send`, {\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\t\t\tbody: 'input=C-u&special=true'\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Clear pending input in Claude\n\t\twindow.clearPendingInput = function() {\n\t\t\tconst bar = document.getElementById('choices-bar');\n\t\t\tconst target = bar?.dataset.paneTarget;\n\t\t\tif (target) {\n\t\t\t\t// Send Ctrl+U to clear the line\n\t\t\t\tfetch(`/pane/${target}/send`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\t\tbody: 'input=C-u&special=true'\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Toggle auto-accept edits (sends Shift+Tab)\n\t\twindow.toggleAutoAccept = function() {\n\t\t\tconst target = document.getElementById('output-container')?.getAttribute('data-pane-target');\n\t\t\tconsole.log('toggleAutoAccept called, target:', target);\n\t\t\tif (target) {\n\t\t\t\tfetch(`/pane/${target}/send`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\t\tbody: 'input=BTab&special=true'\n\t\t\t\t}).then(r => console.log('toggle response:', r.status));\n\t\t\t} else {\n\t\t\t\tconsole.warn('No pane target found for toggle');\n\t\t\t}\n\t\t}\n\n\t\t// Update Claude mode indicator (dynamic - shows whatever mode is active)\n\t\tfunction updateClaudeMode(mode) {\n\t\t\tconst toggle = document.getElementById('autoaccept-toggle');\n\t\t\tconst iconEl = toggle?.querySelector('.autoaccept-icon');\n\t\t\tconst stateEl = document.getElementById('autoaccept-state');\n\t\t\tif (!toggle || !stateEl || !iconEl) return;\n\n\t\t\ttoggle.classList.remove('on', 'off');\n\t\t\tif (mode.state === 'on') {\n\t\t\t\ttoggle.classList.add('on');\n\t\t\t\ticonEl.textContent = mode.icon || '‚èµ‚èµ';\n\t\t\t\tstateEl.textContent = 'on';\n\t\t\t\ttoggle.title = `${mode.label || 'Mode'} on (Shift+Tab to cycle)`;\n\t\t\t} else if (mode.state === 'off') {\n\t\t\t\ttoggle.classList.add('off');\n\t\t\t\ticonEl.textContent = mode.icon || '‚èµ‚èµ';\n\t\t\t\tstateEl.textContent = 'off';\n\t\t\t\ttoggle.title = `${mode.label || 'Mode'} off (Shift+Tab to cycle)`;\n\t\t\t} else {\n\t\t\t\t// No mode detected\n\t\t\t\ticonEl.textContent = '‚èµ‚èµ';\n\t\t\t\tstateEl.textContent = '--';\n\t\t\t\ttoggle.title = 'Toggle mode (Shift+Tab)';\n\t\t\t}\n\t\t}\n\n\t\t// Toggle status section visibility (close button hides it)\n\t\twindow.toggleStatusSection = function() {\n\t\t\tconst section = document.getElementById('status-section');\n\t\t\tsection?.classList.remove('visible');\n\t\t\tlocalStorage.setItem('statusSectionVisible', 'false');\n\t\t}\n\n\t\t// Update Amp status display from structured data\n\t\tfunction updateAmpStatus(status) {\n\t\t\tconst section = document.getElementById('status-section');\n\t\t\tconst ctxEl = document.getElementById('status-context-value');\n\t\t\tconst costEl = document.getElementById('status-cost-value');\n\t\t\tconst modeEl = document.getElementById('status-mode-value');\n\n\t\t\tif (!ctxEl) return;\n\n\t\t\t// Update context usage (e.g., \"27% of 168k\")\n\t\t\tif (status.tokenPercent && status.tokenLimit) {\n\t\t\t\tctxEl.textContent = `${status.tokenPercent} of ${status.tokenLimit}`;\n\t\t\t} else if (status.tokenPercent) {\n\t\t\t\tctxEl.textContent = status.tokenPercent;\n\t\t\t}\n\n\t\t\t// Update cost (e.g., \"$0.63\" or \"$0.63 (free)\")\n\t\t\tif (status.cost) {\n\t\t\t\tcostEl.textContent = status.costNote ? `${status.cost} ${status.costNote}` : status.cost;\n\t\t\t}\n\n\t\t\t// Update mode (e.g., \"smart\", \"rush\", \"auto\")\n\t\t\tif (status.mode) {\n\t\t\t\tmodeEl.textContent = status.mode;\n\t\t\t}\n\n\t\t\t// Show Amp bar, hide Claude bar\n\t\t\tdocument.getElementById('status-bar-amp')?.classList.remove('hidden');\n\t\t\tdocument.getElementById('status-bar-claude')?.classList.add('hidden');\n\n\t\t\t// Auto-show if we have data\n\t\t\tconst hasData = status.tokenPercent || status.cost || status.mode;\n\t\t\tif (hasData) {\n\t\t\t\tconst shouldShow = localStorage.getItem('statusSectionVisible') !== 'false';\n\t\t\t\tif (shouldShow) {\n\t\t\t\t\tsection.classList.add('visible');\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tsection.classList.remove('visible');\n\t\t\t}\n\t\t}\n\n\t\t// Update Claude Code status line (two columns: left scrollable, right fixed)\n\t\tfunction updateClaudeStatusLine(statusLine) {\n\t\t\tconst section = document.getElementById('status-section');\n\t\t\tconst leftEl = document.getElementById('status-line-left');\n\t\t\tconst rightEl = document.getElementById('status-line-right');\n\t\t\tif (!leftEl) return;\n\n\t\t\t// Helper to convert ANSI and fix colors\n\t\t\tfunction processLine(line) {\n\t\t\t\tlet html = ansiUp.ansi_to_html(line);\n\t\t\t\thtml = html.replace(/rgb\\(0,0,187\\)/g, 'rgb(137,180,250)');\n\t\t\t\thtml = html.replace(/rgb\\(0,187,0\\)/g, 'rgb(166,227,161)');\n\t\t\t\thtml = html.replace(/rgb\\(187,0,187\\)/g, 'rgb(243,139,168)');\n\t\t\t\thtml = html.replace(/rgb\\(187,0,0\\)/g, 'rgb(243,139,168)');\n\t\t\t\thtml = html.replace(/rgb\\(187,187,0\\)/g, 'rgb(249,226,175)');\n\t\t\t\thtml = html.replace(/rgb\\(0,187,187\\)/g, 'rgb(137,220,235)');\n\t\t\t\t// Strip mode indicators\n\t\t\t\thtml = html.replace(/--\\s+INSERT\\s+--.*$/, '');\n\t\t\t\thtml = html.replace(/‚èµ‚èµ\\s+accept edits.*$/, '');\n\t\t\t\thtml = html.replace(/‚è∏\\s+plan mode.*$/, '');\n\t\t\t\treturn html.trim();\n\t\t\t}\n\n\t\t\t// Parse status line into left (main info) and right (notifications) columns\n\t\t\t// This is best-effort - if parsing fails, everything goes to left\n\t\t\tconst lines = statusLine.split('\\n').filter(l => l.trim() !== '');\n\t\t\tlet leftParts = [];\n\t\t\tlet rightParts = [];\n\n\t\t\ttry {\n\t\t\t\t// Pattern for CC notifications that should go to right side\n\t\t\t\t// These are specific alert messages, not regular status info\n\t\t\t\tconst notificationPattern = /Context left|auto-compact|compacting/i;\n\n\t\t\t\tfor (const line of lines) {\n\t\t\t\t\t// Try to split on 3+ consecutive spaces (terminal column separator)\n\t\t\t\t\tconst parts = line.split(/\\s{3,}/).filter(p => p.trim());\n\t\t\t\t\t\n\t\t\t\t\tfor (const part of parts) {\n\t\t\t\t\t\tconst processed = processLine(part);\n\t\t\t\t\t\tif (!processed) continue;\n\t\t\t\t\t\t\n\t\t\t\t\t\t// Only specific notifications go to right\n\t\t\t\t\t\tif (notificationPattern.test(part)) {\n\t\t\t\t\t\t\trightParts.push(processed);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tleftParts.push(processed);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\t// Fallback: show everything in left column\n\t\t\t\tconsole.warn('Status line parsing failed:', e);\n\t\t\t\tleftParts = lines.map(l => processLine(l)).filter(p => p);\n\t\t\t\trightParts = [];\n\t\t\t}\n\n\t\t\tleftEl.innerHTML = leftParts.join(' ¬∑ ') || '';\n\t\t\tif (rightEl) rightEl.innerHTML = rightParts.join(' ¬∑ ') || '';\n\n\t\t\t// Show Claude bar, hide Amp bar\n\t\t\tdocument.getElementById('status-bar-amp')?.classList.add('hidden');\n\t\t\tdocument.getElementById('status-bar-claude')?.classList.remove('hidden');\n\n\t\t\t// Auto-show if we have content\n\t\t\tif (statusLine && statusLine.trim() !== '') {\n\t\t\t\tconst shouldShow = localStorage.getItem('statusSectionVisible') !== 'false';\n\t\t\t\tif (shouldShow) {\n\t\t\t\t\tsection.classList.add('visible');\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tsection.classList.remove('visible');\n\t\t\t}\n\t\t}\n\n\t\t// Update mode indicators based on current state\n\t\tfunction updateModeIndicators(mode, claudeMode) {\n\t\t\tconst acceptEl = document.getElementById('accept-indicator');\n\t\t\tconst planEl = document.getElementById('plan-indicator');\n\n\t\t\t// Accept edits indicator\n\t\t\tif (claudeMode.label === 'accept edits' && claudeMode.state === 'on') {\n\t\t\t\tacceptEl?.classList.remove('hidden');\n\t\t\t} else {\n\t\t\t\tacceptEl?.classList.add('hidden');\n\t\t\t}\n\n\t\t\t// Plan mode indicator\n\t\t\tif (claudeMode.label === 'plan mode' && claudeMode.state === 'on') {\n\t\t\t\tplanEl?.classList.remove('hidden');\n\t\t\t} else {\n\t\t\t\tplanEl?.classList.add('hidden');\n\t\t\t}\n\t\t}\n\n\t\t// Cycle Claude modes by sending Shift+Tab to tmux\n\t\twindow.cycleClaudeMode = function() {\n\t\t\tconst paneTarget = document.getElementById('output-container')?.getAttribute('data-pane-target');\n\t\t\tif (!paneTarget) return;\n\n\t\t\tfetch(`/pane/${paneTarget}/send`, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\tbody: 'input=BTab&special=true'\n\t\t\t}).then(response => {\n\t\t\t\tif (!response.ok) console.error('Failed to cycle Claude mode');\n\t\t\t});\n\t\t}\n\n\t\t// Cycle Amp modes by sending Ctrl+Shift+M\n\t\twindow.cycleAmpMode = function() {\n\t\t\tconst paneTarget = document.getElementById('output-container')?.getAttribute('data-pane-target');\n\t\t\tif (!paneTarget) return;\n\n\t\t\t// Amp uses Ctrl+Shift+M to cycle modes (smart -> rush -> auto)\n\t\t\tfetch(`/pane/${paneTarget}/send`, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\tbody: 'input=M-m&special=true'\n\t\t\t}).then(response => {\n\t\t\t\tif (!response.ok) console.error('Failed to cycle Amp mode');\n\t\t\t});\n\t\t}\n\n\t\t// Restore visibility on page load\n\t\tdocument.addEventListener('DOMContentLoaded', function() {\n\t\t\tconst shouldShow = localStorage.getItem('statusSectionVisible') !== 'false';\n\t\t\tif (shouldShow) {\n\t\t\t\tdocument.getElementById('status-section')?.classList.add('visible');\n\t\t\t\tconst btn = document.querySelector('#status-section .status-toggle-btn');\n\t\t\t\tif (btn) btn.textContent = 'Hide';\n\t\t\t}\n\t\t});\n\n\t\t// Terminal font size control (calls host terminal via houston API)\n\t\twindow.fontIncrease = function() {\n\t\t\tfetch('/font/increase', { method: 'POST' })\n\t\t\t\t.then(r => { if (!r.ok) console.error('Font increase failed'); })\n\t\t\t\t.catch(e => console.error('Font increase error:', e));\n\t\t}\n\n\t\twindow.fontDecrease = function() {\n\t\t\tfetch('/font/decrease', { method: 'POST' })\n\t\t\t\t.then(r => { if (!r.ok) console.error('Font decrease failed'); })\n\t\t\t\t.catch(e => console.error('Font decrease error:', e));\n\t\t}\n\n\t\twindow.fontReset = function() {\n\t\t\tfetch('/font/reset', { method: 'POST' })\n\t\t\t\t.then(r => { if (!r.ok) console.error('Font reset failed'); })\n\t\t\t\t.catch(e => console.error('Font reset error:', e));\n\t\t}\n\n\t\t// Handle multiple image attachments\n\t\tlet selectedImages = [];\n\n\t\tfunction updateAttachmentsUI() {\n\t\t\tconst attachmentsArea = document.getElementById('attachments-area');\n\t\t\tif (!attachmentsArea) return;\n\n\t\t\tif (selectedImages.length === 0) {\n\t\t\t\tattachmentsArea.classList.add('hidden');\n\t\t\t\tattachmentsArea.innerHTML = '';\n\t\t\t} else {\n\t\t\t\tattachmentsArea.classList.remove('hidden');\n\t\t\t\tattachmentsArea.innerHTML = selectedImages.map((img, index) => `\n\t\t\t\t\t<div class=\"attachment-pill\">\n\t\t\t\t\t\t<span class=\"attachment-name\" title=\"${img.name}\">üìé ${img.name}</span>\n\t\t\t\t\t\t<button type=\"button\" class=\"attachment-remove\" onclick=\"removeAttachment(${index})\" title=\"Remove\">\n\t\t\t\t\t\t\t<svg width=\"12\" height=\"12\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n\t\t\t\t\t\t\t\t<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"3\" d=\"M6 18L18 6M6 6l12 12\"></path>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t`).join('');\n\t\t\t}\n\t\t}\n\n\t\twindow.removeAttachment = function(index) {\n\t\t\tselectedImages.splice(index, 1);\n\t\t\tupdateAttachmentsUI();\n\t\t};\n\n\t\twindow.handleImageSelect = function(event) {\n\t\t\tconst files = event.target.files;\n\t\t\tif (!files || files.length === 0) return;\n\n\t\t\t// Process all selected files\n\t\t\tArray.from(files).forEach(file => {\n\t\t\t\tconst reader = new FileReader();\n\t\t\t\treader.onload = function(e) {\n\t\t\t\t\tselectedImages.push({\n\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\tdata: e.target.result.split(',')[1] // base64 data without prefix\n\t\t\t\t\t});\n\t\t\t\t\tupdateAttachmentsUI();\n\t\t\t\t};\n\t\t\t\treader.readAsDataURL(file);\n\t\t\t});\n\n\t\t\t// Clear file input to allow selecting the same file again\n\t\t\tevent.target.value = '';\n\t\t};\n\n\t\t// Handle image paste\n\t\tdocument.addEventListener('DOMContentLoaded', function() {\n\t\t\tconst inputField = document.getElementById('input-field');\n\t\t\tif (inputField) {\n\t\t\t\tinputField.addEventListener('paste', function(e) {\n\t\t\t\t\tconst items = e.clipboardData?.items;\n\t\t\t\t\tif (!items) return;\n\n\t\t\t\t\t// Look for images in clipboard\n\t\t\t\t\tlet foundImage = false;\n\t\t\t\t\tfor (let i = 0; i < items.length; i++) {\n\t\t\t\t\t\tif (items[i].type.indexOf('image') !== -1) {\n\t\t\t\t\t\t\tif (!foundImage) {\n\t\t\t\t\t\t\t\te.preventDefault(); // Prevent default paste behavior for images\n\t\t\t\t\t\t\t\tfoundImage = true;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst blob = items[i].getAsFile();\n\t\t\t\t\t\t\tif (!blob) continue;\n\n\t\t\t\t\t\t\t// Generate filename with timestamp\n\t\t\t\t\t\t\tconst ext = blob.type.split('/')[1] || 'png';\n\t\t\t\t\t\t\tconst filename = `pasted-image-${Date.now()}.${ext}`;\n\n\t\t\t\t\t\t\t// Convert to base64\n\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\treader.onload = function(event) {\n\t\t\t\t\t\t\t\tselectedImages.push({\n\t\t\t\t\t\t\t\t\tname: filename,\n\t\t\t\t\t\t\t\t\ttype: blob.type,\n\t\t\t\t\t\t\t\t\tdata: event.target.result.split(',')[1] // base64 data without prefix\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tupdateAttachmentsUI();\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\treader.readAsDataURL(blob);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\t// Handle all form submissions (with or without images)\n\t\tdocument.getElementById('input-form')?.addEventListener('submit', async function(e) {\n\t\t\te.preventDefault();\n\n\t\t\tconst inputField = document.getElementById('input-field');\n\t\t\tconst text = inputField.value.trim();\n\t\t\tconst paneTarget = this.getAttribute('data-pane-target');\n\n\t\t\tif (!paneTarget) return;\n\n\t\t\t// Input validation\n\t\t\tconst MAX_INPUT_LENGTH = 100000; // 100KB limit for input text\n\t\t\tif (text.length > MAX_INPUT_LENGTH) {\n\t\t\t\tconsole.error('Input too long:', text.length, 'characters (max:', MAX_INPUT_LENGTH, ')');\n\t\t\t\talert(`Input is too long (${text.length} characters). Maximum is ${MAX_INPUT_LENGTH} characters.`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Skip submission if input is empty (unless there are images attached)\n\t\t\tif (text.length === 0 && selectedImages.length === 0) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Check if there's pending input that needs to be cleared first\n\t\t\tconst pendingInputBar = document.getElementById('pending-input-bar');\n\t\t\tconst hasPendingInput = pendingInputBar && !pendingInputBar.classList.contains('hidden');\n\n\t\t\t// If there's pending input, send Ctrl+C first to clear it\n\t\t\tif (hasPendingInput) {\n\t\t\t\tawait fetch(`/pane/${paneTarget}/send`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\t\tbody: 'input=C-c&special=true'\n\t\t\t\t});\n\t\t\t\t// Wait a brief moment for the clear to take effect\n\t\t\t\tawait new Promise(resolve => setTimeout(resolve, 100));\n\t\t\t}\n\n\t\t\t// If in NORMAL mode, switch to INSERT mode first\n\t\t\tif (currentVimMode === 'normal') {\n\t\t\t\tawait fetch(`/pane/${paneTarget}/send`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\t\tbody: 'input=i&noenter=true'\n\t\t\t\t});\n\t\t\t\t// Wait for mode switch to take effect\n\t\t\t\tawait new Promise(resolve => setTimeout(resolve, 50));\n\t\t\t}\n\n\t\t\tlet response;\n\n\t\t\tif (selectedImages.length > 0) {\n\t\t\t\t// Send with images\n\t\t\t\tresponse = await fetch(`/pane/${paneTarget}/send-with-images`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\ttext: text,\n\t\t\t\t\t\timages: selectedImages\n\t\t\t\t\t})\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\t// Send text only (URL-encoded, not multipart)\n\t\t\t\tconst params = new URLSearchParams();\n\t\t\t\tparams.append('input', text);\n\t\t\t\tresponse = await fetch(`/pane/${paneTarget}/send`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\t\t\tbody: params\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (response.ok) {\n\t\t\t\t// Clear form and images\n\t\t\t\tinputField.value = '';\n\t\t\t\tinputField.style.height = 'auto';\n\t\t\t\tselectedImages = [];\n\t\t\t\tupdateAttachmentsUI();\n\t\t\t\t// Hide suggestion bar (stale after user sends)\n\t\t\t\tdocument.getElementById('suggestion-bar')?.classList.add('hidden');\n\t\t\t\tsuggestionDismissed = true;\n\t\t\t\tcurrentSuggestion = '';\n\t\t\t} else {\n\t\t\t\tconst errText = await response.text().catch(() => 'Unknown error');\n\t\t\t\tconsole.error('Send failed:', response.status, errText);\n\t\t\t\talert('Failed to send: ' + errText);\n\t\t\t}\n\t\t});\n\n\t\t// Allow Enter to create newlines (for iOS compatibility)\n\t\t// Only submit via Send button\n\t\twindow.handleInputKeydown = function(e) {\n\t\t\t// Cmd/Ctrl+Enter to send (for desktop users who want keyboard shortcut)\n\t\t\tif (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {\n\t\t\t\te.preventDefault();\n\t\t\t\tdocument.getElementById('input-form').requestSubmit();\n\t\t\t}\n\t\t\t// Ctrl+Shift+X to clear all attached images\n\t\t\tif (e.key === 'X' && e.ctrlKey && e.shiftKey) {\n\t\t\t\te.preventDefault();\n\t\t\t\tif (selectedImages.length > 0) {\n\t\t\t\t\tselectedImages = [];\n\t\t\t\t\tupdateAttachmentsUI();\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Regular Enter creates newline (default behavior for textarea)\n\t\t}\n\n\t\t// Auto-resize textarea\n\t\twindow.autoResize = function(el) {\n\t\t\tel.style.height = 'auto';\n\t\t\tel.style.height = Math.min(el.scrollHeight, 120) + 'px';\n\t\t}\n\n\t\tdocument.addEventListener('click', function(e) {\n\t\t\tconst menu = document.getElementById('menu');\n\t\t\tif (!e.target.closest('#menu') && !e.target.closest('[onclick=\"toggleMenu()\"]')) {\n\t\t\t\tmenu.classList.add('hidden');\n\t\t\t}\n\t\t});\n\t</script><script src=\"/static/app.js\"></script>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

var _ = templruntime.GeneratedTemplate
